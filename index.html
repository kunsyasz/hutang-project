<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Hunter: Level 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- FAVICON (Lightning Bolt) -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23b026ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M13 10V3L4 14h7v7l9-11h-7z'/></svg>">
    <!-- APPLE TOUCH ICON (iOS Shortcut - PNG Required for reliability) -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/neon/180/lightning-bolt.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root {
            --neon-green: #b026ff;
            /* Was #00ff41 */
            --dark-bg: #0d0d0d;
            --card-bg: #1a1a1a;
            --danger: #ff3333;
        }

        body {
            background-color: var(--dark-bg);
            /* ANIME ART STYLE BACKGROUND */
            background-image: linear-gradient(to bottom, rgba(13, 13, 20, 0.7), rgba(0, 0, 0, 0.95)), url('https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=1600&auto=format&fit=crop');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            min-height: 100vh;
            /* Memastikan background full layar */

            color: white;
            font-family: 'Inter', sans-serif;
            padding: 0;
            margin: 0;
        }

        .font-tech {
            font-family: 'Share Tech Mono', monospace;
        }

        /* CARD STYLING */
        .game-card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-left: 4px solid var(--neon-green);
            transition: all 0.3s ease;
        }

        .game-card.expanded {
            box-shadow: 0 0 15px rgba(176, 38, 255, 0.3);
            border-color: var(--neon-green);
        }

        /* CHECKBOX CUSTOM */
        .custom-checkbox input:checked+div {
            background-color: var(--neon-green);
            border-color: var(--neon-green);
        }

        .custom-checkbox input:checked+div svg {
            display: block;
        }

        /* PROGRESS CIRCLE */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* ANIMATION */
        .fade-out {
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.5s ease;
        }
    </style>
    <!-- FIREBASE SDK (Module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Expose to window so app.js can use them
        window.firebaseLib = { initializeApp, getDatabase, ref, set, onValue };
        // Dispatch event so app knows we are ready
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
</head>

<body class="pb-20">

    <!-- HEADER STATUS -->
    <div class="fixed top-0 w-full bg-black/90 backdrop-blur border-b border-gray-800 z-50">
        <div class="p-4 flex justify-between items-center max-w-md mx-auto">
            <div class="flex items-center gap-3">
                <!-- SVG LOGO -->
                <div
                    class="w-12 h-12 rounded-full bg-[#1a1a1a] border border-[#b026ff] flex items-center justify-center shadow-[0_0_15px_rgba(176,38,255,0.4)]">
                    <svg class="w-7 h-7 text-[#b026ff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div>
                    <div id="realtime-date" class="text-white text-[10px] font-tech mb-0.5">...</div>
                    <div class="flex items-center gap-2">
                        <h1 class="text-xl font-bold tracking-wider leading-none">DEBT <span
                                class="text-[#b026ff]">HUNTER</span></h1>
                        <span id="sync-status" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"
                            title="Offline"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-gray-500 text-[10px] tracking-widest">KUNSY STATUS: <span
                                class="text-red-500 font-bold">BERHUTANG</span></div>
                        <button onclick="logout()"
                            class="text-[8px] border border-gray-700 px-1 rounded text-gray-500 hover:text-white hover:bg-red-900 transition-colors"
                            title="Logout & Ganti ID">LOGOUT</button>
                    </div>
                </div>
            </div>

            <!-- Circular Progress -->
            <div class="relative w-16 h-16 flex items-center justify-center">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-800 stroke-current" stroke-width="8" cx="50" cy="50" r="40"
                        fill="transparent"></circle>
                    <circle id="progress-circle" class="text-[#b026ff] progress-ring__circle stroke-current"
                        stroke-width="8" stroke-linecap="round" cx="50" cy="50" r="40" fill="transparent"
                        stroke-dasharray="251.2" stroke-dashoffset="0"></circle>
                </svg>
                <div id="progress-text" class="absolute text-xs font-bold">0%</div>
            </div>
        </div>

        <!-- Total Summary Bar -->
        <div class="bg-[#111]/90 backdrop-blur py-2 px-4 border-b border-gray-800">
            <div class="flex justify-between items-center max-w-md mx-auto">
                <span class="text-xs uppercase text-gray-500">Sisa Tanggungan</span>
                <div class="flex items-center gap-2">
                    <span id="grand-total" class="font-tech text-lg text-white">Rp 0</span>
                    <button onclick="window.toggleCalc()"
                        class="text-[10px] bg-[#333] border border-gray-600 text-white px-2 py-1 rounded ml-2 hover:bg-[#b026ff] hover:text-black"
                        title="Kalkulator">
                        CALC
                    </button>
                    <button onclick="resetData()"
                        class="text-[10px] bg-red-900 text-red-100 px-2 py-1 rounded ml-1 hover:bg-red-700">RESET
                        APP</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT SPACE -->
    <div class="pt-36 max-w-md mx-auto px-4 pb-32">
        <!-- INCOME SECTION -->
        <div id="income-container" class="hidden"></div>

        <!-- DEBT LIST -->
        <div id="debt-container">
            <!-- LIST WILL BE INJECTED HERE BY JS -->
        </div>
    </div>

    <!-- FLOATING ACTION BUTTONS (BOTTOM LEFT) -->
    <div class="fixed bottom-6 left-6 z-40 flex flex-col gap-3 items-center">
        <!-- SWITCH MODE FAB -->
        <button onclick="toggleMode()" id="fab-switch"
            class="w-12 h-12 rounded-full bg-gray-800 text-gray-400 border border-gray-600 flex items-center justify-center shadow-lg hover:scale-110 transition-transform hover:text-white group relative">
            <span class="text-xl">‚áÑ</span>
            <span
                class="absolute left-14 bg-black/80 text-white text-[10px] px-2 py-1 rounded hidden group-hover:block whitespace-nowrap border border-gray-700">
                Ganti Mode
            </span>
        </button>

        <!-- ADD DEBT FAB (Main) -->
        <button onclick="openModal()" id="fab-add"
            class="bg-[#b026ff] text-white w-14 h-14 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(176,38,255,0.6)] hover:scale-110 transition-transform font-bold text-3xl">
            +
        </button>
    </div>

    <!-- MODAL ADD FORM -->
    <div id="add-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-[#1a1a1a] border border-[#333] p-6 rounded-lg w-full max-w-sm shadow-[0_0_30px_rgba(0,0,0,0.8)]">
            <h2 class="text-xl font-bold mb-4 text-[#b026ff] font-tech">// TAMBAH MUSUH BARU</h2>

            <form onsubmit="handleFormSubmit(event)" class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">NAMA SUMBER / APLIKASI</label>
                    <input type="text" id="input-nama" required
                        class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none"
                        placeholder="Contoh: Shopee Paylater">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">TOTAL CICILAN (BULAN)</label>
                        <input type="number" id="input-bulan" required min="1" value="1"
                            class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">NOMINAL DEFAULT (Rp)</label>
                        <input type="number" id="input-nominal" required
                            class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none"
                            placeholder="500000">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">TANGGAL JATUH TEMPO PERTAMA</label>
                    <input type="date" id="input-tanggal" required
                        class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 py-3 border border-gray-600 rounded hover:bg-gray-800 text-gray-400">BATAL</button>
                    <button type="submit"
                        class="flex-1 py-3 bg-[#b026ff] text-black font-bold rounded hover:bg-[#9020d0] shadow-lg">SIMPAN</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EDIT FORM -->
    <div id="edit-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
        <div class="bg-[#1a1a1a] border border-[#333] p-6 rounded-lg w-full max-w-sm shadow-[0_0_30px_rgba(0,0,0,0.8)]">
            <h2 class="text-xl font-bold mb-4 text-[#b026ff] font-tech">// EDIT CICILAN</h2>

            <form onsubmit="handleEditSubmit(event)" class="space-y-4">
                <input type="hidden" id="edit-source-id">
                <input type="hidden" id="edit-cicilan-id">

                <div>
                    <label class="block text-xs text-gray-500 mb-1">TANGGAL JATUH TEMPO</label>
                    <input type="date" id="edit-tanggal" required
                        class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none">
                </div>

                <div>
                    <label class="block text-xs text-gray-500 mb-1">NOMINAL (Rp)</label>
                    <input type="number" id="edit-nominal" required
                        class="w-full bg-black border border-gray-700 p-3 rounded text-white focus:border-[#b026ff] outline-none">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 py-3 border border-gray-600 rounded hover:bg-gray-800 text-gray-400">BATAL</button>
                    <button type="submit"
                        class="flex-1 py-3 bg-[#b026ff] text-black font-bold rounded hover:bg-[#9020d0] shadow-lg">UPDATE</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL LOGIN (SYNC) -->
    <div id="login-modal" class="fixed inset-0 bg-black z-[100] flex items-center justify-center p-4">
        <div class="text-center w-full max-w-sm">
            <div class="mb-6 flex justify-center">
                <div
                    class="w-16 h-16 rounded-full bg-[#1a1a1a] border border-[#b026ff] flex items-center justify-center shadow-[0_0_30px_rgba(176,38,255,0.6)] animate-bounce relative">
                    <svg class="w-8 h-8 text-[#b026ff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <!-- Calc Toggle Btn -->
                    <button onclick="window.toggleCalc()"
                        class="absolute -right-12 top-0 bg-[#222] border border-[#b026ff] p-2 rounded-full text-[#b026ff] hover:bg-[#b026ff] hover:text-black transition-all"
                        title="Buka Kalkulator">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-white">DEBT HUNTER</h1>
            <p class="text-gray-500 mb-8 text-sm">Masukkan ID Rahasia untuk Sinkronisasi</p>

            <form onsubmit="handleLogin(event)" class="space-y-4">
                <input type="text" id="login-id" required
                    class="w-full bg-[#111] border border-[#333] p-4 text-center rounded text-white focus:border-[#b026ff] outline-none tracking-widest text-xl uppercase placeholder-gray-700"
                    placeholder="BUAT_NAMA_UNIK">
                <button type="submit"
                    class="w-full py-4 bg-[#b026ff] text-black font-bold rounded hover:bg-[#9020d0] shadow-[0_0_20px_rgba(176,38,255,0.4)] tracking-widest">
                    CONNECT SYSTEM
                </button>
            </form>
            <p class="mt-4 text-[10px] text-gray-600">Gunakan ID yang SAMA di semua device Anda.</p>
        </div>
    </div>

    <!-- CALCULATOR MODAL -->
    <div id="calc-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-[#1a1a1a]/80 backdrop-blur-md w-full max-w-xs rounded-xl overflow-hidden border border-[#333]/50 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
            <!-- Display -->
            <div class="bg-black/40 p-6 text-right border-b border-[#333]/30">
                <div id="calc-history" class="text-gray-500 text-xs h-4 font-mono mb-1"></div>
                <div id="calc-display" class="text-white text-4xl font-tech tracking-widest truncate">0</div>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-4 gap-1 p-2 bg-black/20">
                <button onclick="window.calcClear()"
                    class="col-span-2 bg-[#330000] text-red-200 p-4 rounded text-lg font-bold hover:bg-red-900 active:bg-red-950 transition-colors">AC</button>
                <button onclick="window.calcDelete()"
                    class="bg-gray-800 text-white p-4 rounded text-lg font-bold hover:bg-gray-700 active:scale-95 transition-transform">‚å´</button>
                <button onclick="window.calcOp('/')"
                    class="bg-[#2a0a3d] text-[#d6bcfa] p-4 rounded text-xl font-bold hover:bg-[#b026ff]/30">√∑</button>

                <button onclick="window.calcNum('7')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">7</button>
                <button onclick="window.calcNum('8')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">8</button>
                <button onclick="window.calcNum('9')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">9</button>
                <button onclick="window.calcOp('*')"
                    class="bg-[#2a0a3d] text-[#d6bcfa] p-4 rounded text-xl font-bold hover:bg-[#b026ff]/30">√ó</button>

                <button onclick="window.calcNum('4')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">4</button>
                <button onclick="window.calcNum('5')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">5</button>
                <button onclick="window.calcNum('6')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">6</button>
                <button onclick="window.calcOp('-')"
                    class="bg-[#2a0a3d] text-[#d6bcfa] p-4 rounded text-xl font-bold hover:bg-[#b026ff]/30">‚àí</button>

                <button onclick="window.calcNum('1')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">1</button>
                <button onclick="window.calcNum('2')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">2</button>
                <button onclick="window.calcNum('3')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">3</button>
                <button onclick="window.calcOp('+')"
                    class="bg-[#2a0a3d] text-[#d6bcfa] p-4 rounded text-xl font-bold hover:bg-[#b026ff]/30">+</button>

                <button onclick="window.toggleCalc()"
                    class="bg-gray-900 text-gray-500 p-4 rounded text-sm font-bold hover:bg-gray-800 border border-gray-800">EXIT</button>
                <button onclick="window.calcNum('0')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">0</button>
                <button onclick="window.calcNum('.')"
                    class="bg-[#222] text-white p-4 rounded text-xl font-bold hover:bg-[#333] active:bg-[#444]">.</button>
                <button onclick="window.calcResult()"
                    class="bg-[#b026ff] text-white p-4 rounded text-xl font-bold hover:bg-[#9020d0] shadow-[0_0_15px_rgba(176,38,255,0.4)]">=</button>
            </div>
        </div>
    </div>
    </div>

    <!-- UNIFIED UI LOGIC SCRIPT -->
    <script>
        // ==========================================
        // 1. GLOBAL UI FUNCTION EXPORTS
        // ==========================================

        // --- TAB / MODE SWITCHING ---
        let currentMode = 'debt';

        window.toggleMode = function () {
            const debtContainer = document.getElementById('debt-container');
            const incomeContainer = document.getElementById('income-container');
            const fabAdd = document.getElementById('fab-add');
            const fabSwitch = document.getElementById('fab-switch');
            const headerTitle = document.querySelector('h1.text-xl');

            if (currentMode === 'debt') {
                // SWITCH TO INCOME
                currentMode = 'income';
                if (debtContainer) debtContainer.classList.add('hidden');
                if (incomeContainer) incomeContainer.classList.remove('hidden');

                // Update FABs
                if (fabAdd) fabAdd.classList.add('hidden');
                if (fabSwitch) {
                    fabSwitch.classList.remove('bg-gray-800', 'text-gray-400');
                    fabSwitch.classList.add('bg-[#b026ff]', 'text-white', 'shadow-[0_0_15px_#b026ff]');
                    fabSwitch.innerHTML = '<span class="text-xl">üí∞</span>';
                }

                if (headerTitle) headerTitle.innerHTML = 'YOUR <span class="text-[#b026ff]">INCOME</span>';

                if (window.renderIncomeUI) window.renderIncomeUI();

            } else {
                // SWITCH TO DEBT
                currentMode = 'debt';
                if (debtContainer) debtContainer.classList.remove('hidden');
                if (incomeContainer) incomeContainer.classList.add('hidden');

                // Update FABs
                if (fabAdd) fabAdd.classList.remove('hidden');
                if (fabSwitch) {
                    fabSwitch.classList.add('bg-gray-800', 'text-gray-400');
                    fabSwitch.classList.remove('bg-[#b026ff]', 'text-white', 'shadow-[0_0_15px_#b026ff]');
                    fabSwitch.innerHTML = '<span class="text-xl">‚áÑ</span>';
                }

                if (headerTitle) headerTitle.innerHTML = 'DEBT <span class="text-[#b026ff]">HUNTER</span>';
            }
        };

        // --- CALCULATOR LOGIC ---
        let calcVal = '0';
        let calcPendingOp = '';
        let calcHistory = '';
        let calcNewNum = false;
        let calcPrevVal = '';

        window.toggleCalc = function () {
            const el = document.getElementById('calc-modal');
            if (el) {
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    el.style.display = 'flex'; // Force flex
                } else {
                    el.classList.add('hidden');
                    el.style.display = 'none';
                }
            } else {
                console.error("Calc Modal Not Found");
            }
        };

        function updateCalcDisplay() {
            const display = document.getElementById('calc-display');
            const history = document.getElementById('calc-history');
            if (display) display.innerText = Number(calcVal).toLocaleString('id-ID');
            if (history) history.innerText = calcHistory;
        }

        window.calcNum = function (n) {
            if (calcVal === '0' || calcNewNum) {
                calcVal = n;
                calcNewNum = false;
            } else {
                calcVal += n;
            }
            updateCalcDisplay();
        };

        window.calcOp = function (op) {
            calcHistory = calcVal + ' ' + (op === '*' ? '√ó' : op === '/' ? '√∑' : op);
            calcPendingOp = op;
            calcPrevVal = calcVal;
            calcNewNum = true;
            updateCalcDisplay();
        };

        window.calcResult = function () {
            if (!calcPendingOp) return;
            try {
                const prev = parseFloat(calcPrevVal);
                const current = parseFloat(calcVal);
                let res = 0;
                if (calcPendingOp === '+') res = prev + current;
                if (calcPendingOp === '-') res = prev - current;
                if (calcPendingOp === '*') res = prev * current;
                if (calcPendingOp === '/') res = prev / current;

                calcVal = String(res);
                calcHistory = '';
                calcPendingOp = '';
                calcPrevVal = '';
                calcNewNum = true;
                updateCalcDisplay();
            } catch (e) { calcVal = 'Error'; }
        };

        window.calcClear = function () {
            calcVal = '0';
            calcHistory = '';
            calcPendingOp = '';
            updateCalcDisplay();
        };

        window.calcDelete = function () {
            if (calcVal.length > 1) {
                calcVal = calcVal.slice(0, -1);
            } else {
                calcVal = '0';
            }
            updateCalcDisplay();
        };


        // --- INCOME FUNCTIONS ---
        window.editTarget = function () {
            if (!manajerPendapatan) return alert("System Loading...");
            const currentTarget = manajerPendapatan.target;
            const newTarget = prompt("Masukkan Target Harian Baru (Rp):", currentTarget);

            if (newTarget && !isNaN(newTarget)) {
                manajerPendapatan.setTarget(newTarget);
                saveData();
                window.renderIncomeUI();
            }
        };

        window.manualResetIncome = function () {
            if (confirm("Reset Pendapatan Harian jadi Rp 0?")) {
                manajerPendapatan.resetCurrent();
                saveData(); // Explicit save for persistence
                window.renderIncomeUI();
            }
        };

        window.handleIncomeSubmit = function (e) {
            e.preventDefault();
            const input = document.getElementById('income-input');
            const val = parseInt(input.value);
            if (val > 0) {
                manajerPendapatan.tambahPendapatan(val);
                saveData();
                window.renderIncomeUI();
                renderUI();
                input.value = '';
            }
        };

        window.renderIncomeUI = function () {
            if (!manajerPendapatan) return;
            const data = manajerPendapatan.getProgress();
            const container = document.getElementById('income-container');
            if (!container) return;

            const currentRp = data.current.toLocaleString('id-ID');
            const targetRp = data.target.toLocaleString('id-ID');

            // Use window.editTarget() in onclick to ensure it finds the global function
            container.innerHTML = `
                <div class="game-card p-4 rounded-lg mb-6 border border-[#b026ff]/30 shadow-[0_0_15px_rgba(176,38,255,0.15)] relative overflow-hidden">
                   <div class="absolute -right-4 -top-4 w-24 h-24 bg-[#b026ff]/10 rounded-full blur-xl"></div>
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-xl">üí∞</span>
                            <h2 class="font-bold text-[#b026ff] tracking-wider text-sm">PENDAPATAN HARIAN</h2>
                        </div>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="window.manualResetIncome()" class="text-[10px] text-red-500 hover:text-red-300 underline z-10 relative">
                                RESET
                            </button>
                            <button type="button" onclick="window.editTarget()" class="text-[10px] text-gray-500 hover:text-white underline z-10 relative">
                                SET TARGET
                            </button>
                        </div>
                    </div>
                    <div class="text-center mb-4">
                        <div class="text-3xl font-bold text-white font-tech tracking-widest">Rp ${currentRp}</div>
                        <div class="text-xs text-gray-400 mt-1">Target: Rp ${targetRp}</div>
                    </div>
                    <div class="w-full bg-gray-800 h-3 rounded-full overflow-hidden mb-4 border border-gray-700">
                        <div class="h-full bg-gradient-to-r from-blue-500 to-[#b026ff] transition-all duration-700 relative" style="width: ${data.percent}%">
                            <div class="absolute right-0 top-0 h-full w-1 bg-white/50 blur-[1px]"></div>
                        </div>
                    </div>
                    <form onsubmit="window.handleIncomeSubmit(event)" class="flex gap-2">
                        <input type="number" id="income-input" placeholder="0" required
                            class="flex-1 bg-[#111] border border-[#333] rounded px-3 py-2 text-white text-sm focus:border-[#b026ff] outline-none font-tech">
                        <button type="submit" class="bg-[#222] hover:bg-[#b026ff] hover:text-white text-[#b026ff] border border-[#b026ff] px-4 py-2 rounded text-sm font-bold transition-all">
                            +
                        </button>
                    </form>
                </div>
            `;
        };

    </script>

    <!-- SCRIPT -->
    <script src="app.js"></script>
    <script>
        // === UI LOGIC ===

        const container = document.getElementById('debt-container');
        const dateEl = document.getElementById('realtime-date');
        const circle = document.getElementById('progress-circle');
        const progressText = document.getElementById('progress-text');
        const grandTotalEl = document.getElementById('grand-total');
        const modal = document.getElementById('add-modal');
        const editModal = document.getElementById('edit-modal');

        const CIRCUMFERENCE = 2 * Math.PI * 40; // 251.2

        // 1. UPDATE REALTIME DATE
        // 1. UPDATE REALTIME DATE & CHECK MIDNIGHT
        let lastDateString = "";

        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const currentDateString = now.toLocaleDateString('id-ID', options);

            dateEl.innerText = currentDateString + " | " + now.toLocaleTimeString('id-ID');

            // DETEKSI PERGANTIAN HARI (00:01)
            // Jika tanggal berubah dari sebelumnya, refresh halaman agar Warning muncul
            if (lastDateString && lastDateString !== currentDateString) {
                console.log("Hari berganti! Refreshing UI...");
                renderUI();
            }
            lastDateString = currentDateString;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // 2. RENDER FUNGSI UTAMA
        function renderUI() {
            renderIncomeUI(); // Also render Income UI
            container.innerHTML = ''; // Kosongkan dulu
            const sortedSources = aplikasiSaya.getSortedSources();
            const stats = aplikasiSaya.hasilkanTotal();

            // Update Header Stats
            grandTotalEl.innerText = `Rp ${stats.sisaUang.toLocaleString('id-ID')}`;
            const offset = CIRCUMFERENCE - (stats.persenGlobal / 100) * CIRCUMFERENCE;
            circle.style.strokeDashoffset = offset;
            progressText.innerText = Math.round(stats.persenGlobal) + "%";

            // Render List Items (Musuh)
            let visibleCount = 0; // Hitung cicilan yg tampil untuk styling

            sortedSources.forEach((sumber) => { // Hapus index dari parameter karena tidak aman dipakai saat sorting
                const sisa = sumber.hitungSisa();

                // Cari musuh ini di array asli untuk cek status expanded yang up-to-date
                // (Sebenarnya objectnya sama reference, tapi kita perlu ID buat fungsi toggle)

                const nextJatuhTempo = sumber.getTanggalTerdekat();
                // WARNING LOGIC: Change +7 to +3 days
                const isUrgent = nextJatuhTempo < new Date(new Date().setDate(new Date().getDate() + 3));

                // Card Wrapper
                const card = document.createElement('div');
                card.className = `game-card mb-4 rounded-lg overflow-hidden ${sumber.isExpanded ? 'expanded' : ''}`;

                // 1. HEADER (Clickable)
                const header = document.createElement('div');
                header.className = "p-4 cursor-pointer flex justify-between items-center bg-[#222] hover:bg-[#2a2a2a]";
                // PASS ID, JANGAN PASS INDEX
                header.onclick = () => toggleAccordion(sumber.id);

                const dateDisplay = nextJatuhTempo.getFullYear() === 9999 ? "LUNAS SEMUA" : nextJatuhTempo.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });

                header.innerHTML = `
                    <div>
                        <div class="text-[10px] uppercase tracking-widest ${isUrgent ? 'text-red-500 font-bold' : 'text-gray-500'}">
                            ${isUrgent && sisa > 0 ? '‚ö† WARNING: ' : ''} Jatuh Tempo: ${dateDisplay}
                        </div>
                        <div class="font-bold text-lg">${sumber.namaSumber}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-white font-tech text-sm">Rp ${sisa.toLocaleString('id-ID')}</div>
                        <div class="text-xs text-gray-500">${sumber.isExpanded ? '‚ñ≤ Tutup' : '‚ñº Buka'}</div>
                    </div>
                `;

                // 2. DETAIL LIST (Cicilan) - ADD SCROLL
                const detail = document.createElement('div');
                // Added max-h-[300px] and overflow-y-auto for scrolling
                detail.className = `bg-black border-t border-gray-800 transition-all duration-300 ${sumber.isExpanded ? 'max-h-[300px] opacity-100 overflow-y-auto' : 'max-h-0 opacity-0 overflow-hidden'}`;

                // Render tiap cicilan
                sumber.daftarCicilan.forEach((cicilan) => {
                    // FITUR BARU: Hide kalau lunas kemarin/lampau
                    if (aplikasiSaya.shouldHide(cicilan)) return;

                    visibleCount++;

                    const row = document.createElement('div');
                    row.className = `p-3 border-b border-gray-900 flex justify-between items-center ${cicilan.sudahLunas ? 'bg-[#b026ff]/10' : ''}`;

                    const tgl = cicilan.tanggalJatuhTempo.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

                    // Style coret kalau lunas
                    const textStyle = cicilan.sudahLunas ? 'line-through text-gray-600' : 'text-gray-400';
                    const nominalStyle = cicilan.sudahLunas ? 'text-gray-600' : 'text-white';

                    row.innerHTML = `
                        <div class="flex-1">
                            <div class="text-xs ${textStyle}">Cicilan ke-${cicilan.bulanKe} ‚Ä¢ ${tgl}</div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${nominalStyle}">Rp ${cicilan.nominal.toLocaleString('id-ID')}</span>
                                ${!cicilan.sudahLunas ? `
                                    <button onclick="editCicilan('${sumber.id}', '${cicilan.id}')" class="text-gray-500 hover:text-[#b026ff] text-[10px] border border-gray-700 px-1 rounded">
                                        ‚úè EDIT
                                    </button>
                                ` : ''}
                            </div>
                            ${cicilan.sudahLunas ? '<div class="text-[10px] text-[#b026ff]">LUNAS HARI INI (Besok akan hilang)</div>' : ''}
                        </div>
                        
                        <label class="custom-checkbox cursor-pointer relative flex items-center">
                            <input type="checkbox" class="sr-only" 
                                ${cicilan.sudahLunas ? 'checked' : ''} 
                                onchange="bayarCicilan('${sumber.id}', '${cicilan.id}')">
                            <div class="w-8 h-8 rounded border-2 border-gray-600 flex items-center justify-center transition-colors hover:border-[#b026ff]">
                                <!-- Check Icon -->
                                <svg class="w-5 h-5 text-black hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </label>
                    `;
                    detail.appendChild(row);
                });

                // BUTTON DELETE SOURCE (SAFE AREA)
                const deleteBtnContainer = document.createElement('div');
                deleteBtnContainer.className = "p-4 border-t border-gray-900 bg-black/50 text-center";
                deleteBtnContainer.innerHTML = `
                    <button onclick="hapusHutang('${sumber.id}')" class="text-[10px] text-red-500 hover:text-red-300 border border-red-900/50 px-3 py-1 rounded bg-red-900/20 hover:bg-red-900/40 transition-colors">
                        üóë HAPUS SUMBER HUTANG INI
                    </button>
                `;
                detail.appendChild(deleteBtnContainer);

                if (visibleCount === 0 && !sumber.isExpanded) {
                    // Optional: Kalau semua hidden/lunas lama, kasih info
                }

                card.appendChild(header);
                card.appendChild(detail);
                container.appendChild(card);
            });
        }

        // === LOGIC INTERAKSI ===

        // === LOGIC INTERAKSI ===

        function toggleAccordion(sourceId) {
            const target = aplikasiSaya.semuaSumber.find(s => s.id === sourceId);
            if (!target) return;

            // REMOVED AUTO-CLOSE LOGIC - User wants to open multiple tabs
            // Toggle yang diklik
            target.isExpanded = !target.isExpanded;
            saveData(); // Sync to Cloud
            renderUI();
        }

        function bayarCicilan(sourceId, cicilanId) {
            const sumber = aplikasiSaya.semuaSumber.find(s => s.id === sourceId);
            if (!sumber) return;
            // ... (rest of function)

            const cicilan = sumber.daftarCicilan.find(c => c.id === cicilanId);

            if (cicilan) {
                // TOGGLE LOGIC: Bisa Uncheck kalau masih hari yang sama
                cicilan.sudahLunas = !cicilan.sudahLunas;

                if (cicilan.sudahLunas) {
                    cicilan.tanggalDibayar = new Date(); // Set time now
                } else {
                    cicilan.tanggalDibayar = null; // Reset
                }

                saveData(); // SIMPAN PERUBAHAN KE LOCAL STORAGE
                renderUI();
            }
        }

        function editCicilan(sourceId, cicilanId) {
            const sumber = aplikasiSaya.semuaSumber.find(s => s.id === sourceId);
            const cicilan = sumber.daftarCicilan.find(c => c.id === cicilanId);

            if (cicilan) {
                // Populate Form
                document.getElementById('edit-source-id').value = sourceId;
                document.getElementById('edit-cicilan-id').value = cicilanId;
                document.getElementById('edit-nominal').value = cicilan.nominal;

                // Format Date for Input (YYYY-MM-DD)
                const yyyy = cicilan.tanggalJatuhTempo.getFullYear();
                const mm = String(cicilan.tanggalJatuhTempo.getMonth() + 1).padStart(2, '0');
                const dd = String(cicilan.tanggalJatuhTempo.getDate()).padStart(2, '0');
                document.getElementById('edit-tanggal').value = `${yyyy}-${mm}-${dd}`;

                // Show Modal
                editModal.classList.remove('hidden');
                editModal.classList.add('flex');
            }
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }

        function handleEditSubmit(e) {
            e.preventDefault();
            const sourceId = document.getElementById('edit-source-id').value;
            const cicilanId = document.getElementById('edit-cicilan-id').value;
            const nominal = document.getElementById('edit-nominal').value;
            const tanggal = document.getElementById('edit-tanggal').value;

            if (sourceId && cicilanId && nominal && tanggal) {
                aplikasiSaya.updateCicilan(sourceId, cicilanId, nominal, tanggal);
                saveData();
                renderUI();
                closeEditModal();
            }
        }

        function resetData() {
            if (confirm("PERINGATAN: APUS SEMUA DATA?\n\nSemua data hutang akan hilang permanen dan jadi kosong (nol). Anda harus input manual lagi nanti.")) {
                aplikasiSaya.resetAllData();
            }
        }

        // === FORM MODAL LOGIC ===
        function openModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Set default date to today
            document.getElementById('input-tanggal').valueAsDate = new Date();
        }

        function closeModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const nama = document.getElementById('input-nama').value;
            const bulan = parseInt(document.getElementById('input-bulan').value);
            const nominal = parseInt(document.getElementById('input-nominal').value);
            const tanggal = document.getElementById('input-tanggal').value;

            if (nama && bulan && nominal && tanggal) {
                // Tambah data via method baru di app.js
                aplikasiSaya.tambahSumberOtomatis(nama, bulan, tanggal, nominal);

                saveData(); // Simpan ke storage
                renderUI(); // Render ulang
                closeModal(); // Tutup modal
                e.target.reset(); // Reset form
            }
        }

        // === LOGIN LOGIC ===
        const SAVED_ID_KEY = 'DEBT_HUNTER_USER_ID';

        function checkAutoLogin() {
            const savedId = localStorage.getItem(SAVED_ID_KEY);
            if (savedId) {
                console.log("Auto Login as:", savedId);
                initApp(savedId);
                document.getElementById('login-modal').classList.add('hidden');
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const userId = document.getElementById('login-id').value.trim().replace(/\s+/g, '_').toUpperCase();

            if (!userId || userId.length < 4) {
                alert("ID terlalu pendek! Minimal 4 huruf.");
                return;
            }

            // CHECK FIREBASE READINESS
            if (!window.firebaseLib) {
                alert("Sistem sedang memuat... Tunggu 2 detik dan coba lagi.");
                return;
            }

            // Save ID
            localStorage.setItem(SAVED_ID_KEY, userId);

            // Initialize App
            initApp(userId);
            document.getElementById('login-modal').classList.add('hidden');
        }

        function hapusHutang(sourceId) {
            if (confirm("YAKIN MENGHAPUS HUTANG INI?\nData yang dihapus tidak bisa dikembalikan!")) {
                aplikasiSaya.hapusSumber(sourceId);
                renderUI();
            }
        }

        function logout() {
            if (confirm("Yakin ingin Logout? ID yang tersimpan akan dihapus dari perangkat ini.")) {
                localStorage.removeItem(SAVED_ID_KEY);
                location.reload();
            }
        }

        // START APP (Wait for Firebase)
        if (window.firebaseLib) {
            checkAutoLogin();
        } else {
            window.addEventListener('firebase-ready', () => {
                checkAutoLogin();
            });
        }

    </script>
</body>

</html>
